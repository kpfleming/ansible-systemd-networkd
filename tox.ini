[tox]
envlist=lint
skipsdist=True
[ansible-base]
deps=
    ansible
commands=
    python -VV
[galaxy-base]
deps=
    ansible
setenv=
    ANSIBLE_COLLECTIONS_PATH={envtmpdir}/collections
commands=
    ansible-playbook -i localhost, workflow-support/make-galaxy-yml.yml
    ansible-galaxy collection install -p {env:ANSIBLE_COLLECTIONS_PATH} src
[lint-base]
deps=
    ansible-lint
[testenv:lint-action]
ignore_errors=true
allowlist_externals=bash
deps=
    {[galaxy-base]deps}
    {[lint-base]deps}
setenv=
    {[galaxy-base]setenv}
commands=
    {[galaxy-base]commands}
    bash -c 'shellcheck workflow-support/*.sh'
    bash -c 'ansible-lint --write=all -v workflow-support/*.yml src/roles/*'
[testenv:lint]
allowlist_externals=bash
deps=
    {[galaxy-base]deps}
    {[lint-base]deps}
setenv=
    {[galaxy-base]setenv}
commands=
    {[galaxy-base]commands}
    bash -c 'shellcheck workflow-support/*.sh'
    bash -c 'ansible-lint --write=all -v workflow-support/*.yml src/roles/*'
[testenv:py310-ansible]
deps=
    {[galaxy-base]deps}
    {[ansible-base]deps}
setenv=
    {[galaxy-base]setenv}
commands=
    {[galaxy-base]commands}
    {[ansible-base]commands}
[testenv:build]
deps=
    {[galaxy-base]deps}
setenv=
    TAG=0.0.0
commands=
    ansible-playbook -i localhost, workflow-support/build.yml
[testenv:publish-action]
passenv=ANSIBLE_GALAXY_TOKEN TAG
deps=
    {[galaxy-base]deps}
commands=
    ansible-playbook -i localhost, workflow-support/build.yml
    ansible-playbook -i localhost, workflow-support/publish.yml
